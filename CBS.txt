import javafx.application.Application;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.layout.*;
import javafx.stage.Stage;
import javafx.collections.*;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.shape.*;
import javafx.scene.text.Text;
import java.time.LocalTime;
import java.util.*;
import java.io.*;

public class CBS extends Application {
    private List<Cab> availableCabs = new ArrayList<>();
    private ObservableList<BookingRecord> bookingHistory = FXCollections.observableArrayList();
    private TextArea statusArea = new TextArea();
    private Pane mapPane = new Pane();

    @Override
    public void start(Stage stage) {
        setupCabs();

        Label header = new Label("Cab Booking System");
        header.setStyle("-fx-font-size: 22px; -fx-font-weight: bold; -fx-text-fill: #2c3e50;");

        Label nameLabel = new Label("Name:");
        TextField nameField = new TextField();
        Label pickLabel = new Label("Pickup Location:");
        TextField pickField = new TextField();
        pickField.setPromptText("Enter Pickup Place");
        Label dropLabel = new Label("Drop Location:");
        TextField dropField = new TextField();
        dropField.setPromptText("Enter Drop Place");
        Label carLabel = new Label("Cab Type:");
        ComboBox<String> carTypeBox = new ComboBox<>();
        carTypeBox.getItems().addAll("Standard", "Deluxe", "SUV");
        carTypeBox.setValue("Standard");

        Button bookButton = new Button("Book Cab");
        bookButton.setStyle("-fx-background-color: #27ae60; -fx-text-fill: white; -fx-font-weight: bold;");
        Button clearButton = new Button("Clear");
        clearButton.setStyle("-fx-background-color: #c0392b; -fx-text-fill: white; -fx-font-weight: bold;");

        statusArea.setEditable(false); statusArea.setPrefRowCount(8);
        statusArea.setStyle("-fx-control-inner-background: #ecf0f1; -fx-font-size: 15px; -fx-text-fill: #2c3e50;");

        // Booking History Table
        TableView<BookingRecord> historyTable = new TableView<>(bookingHistory);
        historyTable.setPrefHeight(180);
        TableColumn<BookingRecord, String> nameCol = new TableColumn<>("Name");
        nameCol.setCellValueFactory(new PropertyValueFactory<>("name"));
        nameCol.setPrefWidth(80);
        TableColumn<BookingRecord, String> pickupCol = new TableColumn<>("Pickup");
        pickupCol.setCellValueFactory(new PropertyValueFactory<>("pickup"));
        pickupCol.setPrefWidth(80);
        TableColumn<BookingRecord, String> dropCol = new TableColumn<>("Drop");
        dropCol.setCellValueFactory(new PropertyValueFactory<>("drop"));
        dropCol.setPrefWidth(80);
        TableColumn<BookingRecord, String> typeCol = new TableColumn<>("Type");
        typeCol.setCellValueFactory(new PropertyValueFactory<>("type"));
        typeCol.setPrefWidth(70);
        TableColumn<BookingRecord, String> carCol = new TableColumn<>("Car Details");
        carCol.setCellValueFactory(new PropertyValueFactory<>("carDescription"));
        carCol.setPrefWidth(150);
        TableColumn<BookingRecord, String> fareCol = new TableColumn<>("Fare");
        fareCol.setCellValueFactory(new PropertyValueFactory<>("fareDisplay"));
        fareCol.setPrefWidth(70);
        TableColumn<BookingRecord, String> otpCol = new TableColumn<>("OTP");
        otpCol.setCellValueFactory(new PropertyValueFactory<>("otp"));
        otpCol.setPrefWidth(90);
        TableColumn<BookingRecord, String> driverCol = new TableColumn<>("Driver");
        driverCol.setCellValueFactory(new PropertyValueFactory<>("driverName"));
        driverCol.setPrefWidth(80);
        TableColumn<BookingRecord, String> arrivalCol = new TableColumn<>("Cab Arrival (min)");
        arrivalCol.setCellValueFactory(new PropertyValueFactory<>("cabArrivalTimeDisplay"));
        arrivalCol.setPrefWidth(90);
        TableColumn<BookingRecord, String> rideCol = new TableColumn<>("Ride Estimate (min)");
        rideCol.setCellValueFactory(new PropertyValueFactory<>("rideTimeDisplay"));
        rideCol.setPrefWidth(100);
        historyTable.getColumns().addAll(nameCol, pickupCol, dropCol, typeCol, carCol, fareCol, otpCol, driverCol, arrivalCol, rideCol);
        historyTable.setPlaceholder(new Label("No bookings yet."));

        // Map Pane (Schematic Route)
        mapPane.setPrefSize(350, 130);
        mapPane.setStyle("-fx-background-color: #f7fafc; -fx-border-color: #757575; -fx-border-width: 1;");

        // Layout
        GridPane form = new GridPane();
        form.setHgap(12); form.setVgap(14); form.setAlignment(Pos.CENTER);
        form.setPadding(new Insets(20, 24, 24, 24));
        form.add(nameLabel, 0, 0); form.add(nameField, 1, 0);
        form.add(pickLabel, 0, 1); form.add(pickField, 1, 1);
        form.add(dropLabel, 0, 2); form.add(dropField, 1, 2);
        form.add(carLabel, 0, 3); form.add(carTypeBox, 1, 3);
        form.add(bookButton, 0, 4); form.add(clearButton, 1, 4);

        VBox root = new VBox(18, header, form, statusArea, new Label("Route Map:"), mapPane, new Label("Booking History:"), historyTable);
        root.setAlignment(Pos.TOP_CENTER);
        root.setStyle("-fx-background-color: linear-gradient(to bottom, #87cefa, #f0fff0;");
        root.setPadding(new Insets(10, 20, 20, 20));

        // Event Handling with Car Description, OTP, and Time Estimates
        bookButton.setOnAction(e -> {
            String name = nameField.getText().trim();
            String pickup = pickField.getText().trim();
            String drop = dropField.getText().trim();
            String carType = carTypeBox.getValue();
            if (name.isEmpty() || pickup.isEmpty() || drop.isEmpty()) {
                statusArea.setText("Please fill in all fields.");
                return;
            }
            if (pickup.equalsIgnoreCase(drop)) {
                statusArea.setText("Pickup and drop locations must be different.");
                return;
            }
            try {
                Cab cab = bookCab(name, pickup, drop, carType);
                double fare = calculateFare(carType, pickup, drop);
                String fareInfo = String.format("₹%.2f", fare);
                String otp = generateOTP();
                double toPickupMin = estimateToPickupMinutes();
                double rideMin = estimateRideMinutes(pickup, drop);
                statusArea.setText(
                    "\u2705 Booked! " + cab.getFullDescription() +
                    "\nDriver: " + cab.driver.name +
                    "\nRoute: " + pickup + " \u27A1 " + drop +
                    "\nFare: " + fareInfo + (isPeakHour() ? " (Peak hour rates applied)" : "") +
                    "\nYour OTP: " + otp +
                    String.format("\n\nEstimated cab arrival: %.1f min\nEstimated ride duration: %.1f min", toPickupMin, rideMin)
                );
                mapPane.getChildren().clear();
                double x1 = 60 + (pickup.hashCode() % 180), y1 = 90;
                double x2 = 60 + (drop.hashCode() % 180), y2 = 40;
                Line route = new Line(x1, y1, x2, y2);
                route.setStrokeWidth(4);
                route.setStroke(javafx.scene.paint.Color.DODGERBLUE);
                Circle pickCircle = new Circle(x1, y1, 11, javafx.scene.paint.Color.LIMEGREEN);
                Circle dropCircle = new Circle(x2, y2, 11, javafx.scene.paint.Color.RED);
                Text pickLabel = new Text(x1 - 20, y1 + 25, "Pickup: " + pickup);
                Text dropLabel = new Text(x2 - 20, y2 - 15, "Drop: " + drop);
                mapPane.getChildren().addAll(route, pickCircle, dropCircle, pickLabel, dropLabel);
                BookingRecord record = new BookingRecord(
                    name, pickup, drop, carType, cab, fare, otp, cab.driver.name, cab.getFullDescription(),
                    String.format("%.1f", toPickupMin), String.format("%.1f", rideMin)
                );
                bookingHistory.add(record);
                saveBooking(record);
            } catch (NoCabAvailableException ex) {
                statusArea.setText("❌ No " + carType + " cabs available!");
            } catch (Exception ex) {
                statusArea.setText("Error: " + ex.getMessage());
            }
        });
        clearButton.setOnAction(e -> {
            nameField.clear(); pickField.clear(); dropField.clear(); statusArea.clear(); carTypeBox.setValue("Standard");
            mapPane.getChildren().clear();
        });
        BookingRecord last = loadBooking();
        if (last != null) bookingHistory.add(last);
        stage.setTitle("Cab Booking System");
        stage.setScene(new Scene(root, 880, 720));
        stage.show();
    }

    private void setupCabs() {
        availableCabs.add(new StandardCab("MH12AB1234", new Driver("Amit"), "White", "Maruti Suzuki"));
        availableCabs.add(new DeluxeCab("MH02CD5678", new Driver("Sunita"), "Grey", "WagonR"));
        availableCabs.add(new SUVCab("MH03EF1122", new Driver("Raj"), "Black", "Hyundai Creta"));
    }

    private Cab bookCab(String user, String pickup, String drop, String carType) throws NoCabAvailableException {
        for (Iterator<Cab> it = availableCabs.iterator(); it.hasNext();) {
            Cab cab = it.next();
            if (cab.getType().equalsIgnoreCase(carType)) {
                it.remove();
                cab.bookedBy = user; cab.pickupLocation = pickup; cab.dropLocation = drop;
                return cab;
            }
        }
        throw new NoCabAvailableException();
    }

    private void saveBooking(BookingRecord record) throws IOException {
        try (ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream("booking.ser"))) {
            oos.writeObject(record);
        }
    }
    private BookingRecord loadBooking() {
        try (ObjectInputStream ois = new ObjectInputStream(new FileInputStream("booking.ser"))) {
            return (BookingRecord) ois.readObject();
        } catch (Exception e) {
            return null;
        }
    }
    private double calculateFare(String cabType, String pickup, String drop) {
        int baseDistance = Math.abs(pickup.length() - drop.length()) + 5;
        double rate;
        switch (cabType) {
            case "Standard": rate = 10.0; break;
            case "Deluxe":   rate = 15.0; break;
            case "SUV":      rate = 20.0; break;
            default:          rate = 10.0;
        }
        double multiplier = isPeakHour() ? 1.5 : 1.0;
        return baseDistance * rate * multiplier;
    }
    private boolean isPeakHour() {
        int hour = LocalTime.now().getHour();
        return (hour >= 18 && hour < 21);
    }
    private String generateOTP() {
        Random r = new Random();
        int otp = 100000 + r.nextInt(900000);
        return String.valueOf(otp);
    }
    private double estimateToPickupMinutes() {
        Random r = new Random();
        int dist = 1 + r.nextInt(5); // 1–5 km
        double speed = 20.0; // km/h
        return (dist / speed) * 60;
    }
    private double estimateRideMinutes(String pickup, String drop) {
        int dist = Math.abs(pickup.length() - drop.length()) + 5; // as above
        double speed = 30.0; // km/h
        return (dist / speed) * 60;
    }
    public static void main(String[] args) { launch(args); }
}

abstract class Cab implements Serializable {
    String licensePlate, bookedBy, pickupLocation, dropLocation, color, model;
    Driver driver;
    public Cab(String lp, Driver dr, String color, String model) {
        licensePlate = lp; driver = dr; this.color = color; this.model = model;
    }
    public abstract String getType();
    public String getFullDescription() {
        return color + " " + model + " (" + getType() + ", Plate: " + licensePlate + ")";
    }
    public String toString() {
        return getFullDescription() + " - Driver: " + driver.name;
    }
}
class StandardCab extends Cab {
    public StandardCab(String lp, Driver dr, String color, String model) {
        super(lp, dr, color, model); }
    public String getType() { return "Standard"; }
}
class DeluxeCab extends Cab {
    public DeluxeCab(String lp, Driver dr, String color, String model) {
        super(lp, dr, color, model); }
    public String getType() { return "Deluxe"; }
}
class SUVCab extends Cab {
    public SUVCab(String lp, Driver dr, String color, String model) {
        super(lp, dr, color, model); }
    public String getType() { return "SUV"; }
}
class Driver implements Serializable {
    String name;
    public Driver(String n) { name = n; }
}
class NoCabAvailableException extends Exception {
    public NoCabAvailableException() { super("No cab available of selected type."); }
}
class BookingRecord implements Serializable {
    String name, pickup, drop, type, otp, driverName, carDescription;
    Cab cab;
    double fare;
    String cabArrivalTime, rideTime;
    public BookingRecord(String name, String pickup, String drop, String type, Cab cab, double fare, String otp, String driverName, String carDescription, String cabArrivalTime, String rideTime) {
        this.name = name; this.pickup = pickup; this.drop = drop; this.type = type; this.cab = cab;
        this.fare = fare; this.otp = otp; this.driverName = driverName; this.carDescription = carDescription;
        this.cabArrivalTime = cabArrivalTime; this.rideTime = rideTime;
    }
    public String getName() { return name; }
    public String getPickup() { return pickup; }
    public String getDrop() { return drop; }
    public String getType() { return type; }
    public String getFareDisplay() { return String.format("₹%.2f", fare); }
    public String getOtp() { return otp; }
    public String getDriverName() { return driverName; }
    public String getCarDescription() { return carDescription; }
    public String getCabArrivalTimeDisplay() { return cabArrivalTime; }
    public String getRideTimeDisplay() { return rideTime; }
}
